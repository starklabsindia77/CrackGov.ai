// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String
  name              String?
  role              String   @default("user") // "user" | "admin"
  subscriptionStatus String  @default("free") // "free" | "pro"
  emailVerified     Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tests         Test[]
  attempts      TestAttempt[]
  studyPlans    StudyPlan[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  onboardingCompleted Boolean  @default(false)
  notifications       Notification[]
  studyReminders      StudyReminder[]
  bookmarks           Bookmark[]
  notes               Note[]
  studyStreaks        StudyStreak[]
  userSegments        UserSegment[]
  questionAttempts    QuestionAttempt[]
}

model Test {
  id        String          @id @default(cuid())
  user      User            @relation(fields: [userId], references: [id])
  userId    String
  exam      String
  createdAt DateTime        @default(now())

  questions TestQuestion[]
  attempts  TestAttempt[]
}

model TestQuestion {
  id            String   @id @default(cuid())
  test          Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  testId        String
  question      String
  options       Json     // array of strings
  correctOption String
  explanation   String?
  topic         String?

  @@index([testId])
}

model TestAttempt {
  id         String   @id @default(cuid())
  test       Test     @relation(fields: [testId], references: [id])
  testId     String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  score      Int
  total      Int
  accuracy   Float
  details    Json     // per-question result, maybe topic breakdown
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([testId])
}

model AiProvider {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique // e.g. "OPENAI", "GEMINI", "CLAUDE"
  status       String   @default("active") // "active" | "inactive"
  defaultModel String?
  config       Json?    // base URL, timeouts, etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  keys     AiProviderKey[]
  primaryFeatures   AiFeatureConfig[] @relation("PrimaryProvider")
  secondaryFeatures AiFeatureConfig[] @relation("SecondaryProvider")
}

model AiProviderKey {
  id           String     @id @default(cuid())
  provider     AiProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId   String
  label        String?
  apiKeyEnc    String      // encrypted key
  status       String      @default("healthy") // "healthy" | "failing" | "disabled"
  priority     Int         @default(0) // 0-9, lower is higher priority
  lastUsedAt   DateTime?
  lastErrorAt  DateTime?
  failureCount Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([providerId])
  @@index([providerId, status])
}

model AiFeatureConfig {
  id            String      @id @default(cuid())
  featureCode   String      @unique // e.g. "STUDY_PLAN", "MOCK_TEST", "DOUBT_CHAT"
  primaryProvider   AiProvider? @relation("PrimaryProvider", fields: [primaryProviderId], references: [id])
  primaryProviderId String?
  secondaryProvider AiProvider? @relation("SecondaryProvider", fields: [secondaryProviderId], references: [id])
  secondaryProviderId String?
  settings      Json?       // per-feature config: maxTokens, temperature, etc.
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model StudyPlan {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  exam        String
  targetDate  String
  hoursPerDay Int
  weakTopics  String[] // array of weak topics
  planData    Json     // the full study plan structure
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// CMS Models
model Page {
  id          String   @id @default(cuid())
  slug        String   @unique // e.g. "home", "about", "terms", "privacy"
  title       String
  content     String   // HTML or Markdown content
  metaTitle   String?
  metaDescription String?
  published   Boolean  @default(false)
  order       Int      @default(0) // For drag-and-drop ordering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([published])
  @@index([order])
}

model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String   // HTML or Markdown content
  featuredImage String?
  author      String?
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([published])
  @@index([publishedAt])
}

model Faq {
  id          String   @id @default(cuid())
  question    String
  answer      String   // HTML or Markdown content
  category    String?   // e.g. "general", "subscription", "technical"
  order       Int       @default(0)
  published   Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([category])
  @@index([published])
  @@index([order])
}

model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   // HTML or Markdown content
  type        String   @default("info") // "info", "warning", "success", "error"
  priority    Int      @default(0) // Higher priority shows first
  startDate   DateTime?
  endDate     DateTime?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([published])
  @@index([priority])
  @@index([startDate, endDate])
}

model Banner {
  id          String   @id @default(cuid())
  title       String?
  content     String   // HTML or Markdown content
  imageUrl    String?
  linkUrl     String?
  position    String   @default("top") // "top", "bottom", "sidebar"
  priority    Int      @default(0)
  startDate   DateTime?
  endDate     DateTime?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([published])
  @@index([position])
  @@index([priority])
}

// Phase 3 Models
model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  title     String
  message   String
  type      String   @default("info") // "info", "success", "warning", "error"
  read      Boolean  @default(false)
  link      String?  // Optional link to related page
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

model StudyReminder {
  id          String   @id @default(cuid())
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  exam        String
  targetDate  DateTime
  message     String?
  enabled     Boolean @default(true)
  lastSentAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([userId, enabled])
  @@index([targetDate])
}

model Bookmark {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  type        String   // "question", "test", "study_plan", "note"
  itemId      String   // ID of the bookmarked item
  title       String?  // Display title
  metadata    Json?    // Additional metadata
  createdAt   DateTime @default(now())

  @@unique([userId, type, itemId])
  @@index([userId])
  @@index([userId, type])
}

model Note {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  type        String   // "question", "test", "study_plan", "general"
  itemId      String?  // ID of the related item (if applicable)
  title       String?
  content     String   // Markdown or plain text
  tags        String[] // Array of tags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([userId, type])
  @@index([userId, itemId])
}

model StudyStreak {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  date        DateTime @default(now())
  activityType String   // "test", "study_plan", "doubt", "all"
  createdAt   DateTime @default(now())

  @@unique([userId, date, activityType])
  @@index([userId])
  @@index([userId, date])
}

// Question Bank Models
model QuestionBank {
  id            String   @id @default(cuid())
  exam          String   // e.g. "UPSC", "SSC", "Banking"
  subject       String?  // Optional subject categorization
  topic         String?  // Topic/subject area
  question      String
  options       Json     // array of strings
  correctOption String
  explanation   String?
  difficulty    String   @default("medium") // "easy", "medium", "hard"
  source        String?  // e.g. "Previous Year", "AI Generated"
  year          Int?     // For previous year questions
  tags          String[] // Array of tags for better search
  usageCount    Int      @default(0) // How many times used in tests
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  // Admin user ID if manually created

  attempts      QuestionAttempt[]

  @@index([exam])
  @@index([topic])
  @@index([difficulty])
  @@index([exam, topic])
  @@index([exam, difficulty])
}

model QuestionAttempt {
  id            String       @id @default(cuid())
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  question      QuestionBank  @relation(fields: [questionId], references: [id])
  questionId    String
  selectedOption String?
  isCorrect     Boolean
  timeSpent     Int?         // Time in seconds
  createdAt     DateTime     @default(now())

  @@index([userId])
  @@index([questionId])
  @@index([userId, createdAt])
}

// User Segmentation
model UserSegment {
  id          String   @id @default(cuid())
  name        String
  description String?
  criteria    Json     // Criteria for segment (e.g., subscriptionStatus, exam type, etc.)
  userCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships UserSegmentMembership[]

  @@index([name])
}

// Enhanced User model for segmentation
model UserSegmentMembership {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  segment     UserSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  segmentId   String
  createdAt   DateTime @default(now())

  @@unique([userId, segmentId])
  @@index([userId])
  @@index([segmentId])
}

